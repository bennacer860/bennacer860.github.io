
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>The Road To Mastery</title>
  <meta name="author" content="Rafik Bennacer">

  
  <meta name="description" content="I Recently had to share some documents from my Google Drive with a team of developers outside the office. Most of these documents were API docs. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://bennacer860.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="The Road To Mastery" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  


  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-12142135-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>




</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">The Road To Mastery</a></h1>
  
    <h2>From Ruby intermediate to Master...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:bennacer860.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/12/find-who-is-accessing-my-google-drive-files/">Find Who Is Accessing My Google Drive Files</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-07-12T15:20:15-04:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2015/07/12/find-who-is-accessing-my-google-drive-files/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I Recently had to share some documents from my Google Drive with a team of developers outside the office. Most of these documents were API docs. After a couple of months and when those developers didn&rsquo;t need the API docs anymore, it was almost impossible for me to find what i shared with them, it was like looking for a needle in a haystack. I bet i am not the only one that had this problem before!!!</p>

<p>So how would i do that manually. I would go to each file and click on share button. see the list of the permission and remove the users i don&rsquo;t want to. It means that i would need to go through 200 files!!! I am too lazy for that!!</p>

<p> <img src="http://i.stack.imgur.com/tVwCC.gif" alt="https://github.com/gimite/google-drive-ruby" /></p>

<p>Since i like Ruby programming i thought about using the Google Drive API to accomplish this task. I looked at <a href="https://github.com/gimite/google-drive-ruby">this gem</a> and i was immediately discouraged by it&rsquo;s complexity.  It has to be a better solution!!!</p>

<p>After looking at <a href="https://developers.google.com/apps-script/overview">Google Script overview page</a> i realized that this is going to be fairly easy to solve an amazing complex problem. Google Script use a language based on Javascript and this <a href="https://developers.google.com/apps-script/reference/calendar/">API doc</a>.</p>

<p>This code is largely inspired from <a href="">Amit Agarwal</a> code.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function Start() {
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>  var files = DriveApp.getFiles();  
</span><span class='line'>  var timezone = Session.getScriptTimeZone();
</span><span class='line'>  var email = Session.getActiveUser().getEmail();
</span><span class='line'>  
</span><span class='line'>  var MAXFILES = 300; count=1;
</span><span class='line'>  var file, date, access, url, permission;
</span><span class='line'>  var privacy, view, viewers, edit, editors;
</span><span class='line'>  
</span><span class='line'>  var rows = [["File Name", "Who has access?", "Date Created"]];
</span><span class='line'>  
</span><span class='line'>  for (var i=0; i&lt;MAXFILES && files.hasNext(); i++ ) {
</span><span class='line'>    
</span><span class='line'>    file = files.next();
</span><span class='line'>    
</span><span class='line'>    try {
</span><span class='line'>      
</span><span class='line'>      access     = file.getSharingAccess();
</span><span class='line'>      permission = file.getSharingPermission();
</span><span class='line'>      viewers    = file.getViewers();      
</span><span class='line'>      editors    = file.getEditors();
</span><span class='line'>      
</span><span class='line'>      view = [];
</span><span class='line'>      edit = [];
</span><span class='line'>      
</span><span class='line'>      date =  Utilities.formatDate(file.getDateCreated(), timezone, "yyyy-MM-dd HH:mm")
</span><span class='line'>      url = count++ + '. &lt;a href="' + file.getUrl() + '"&gt;' + file.getName() + '&lt;/a&gt;';
</span><span class='line'>      
</span><span class='line'>      for (var v=0; v&lt;viewers.length; v++) {                
</span><span class='line'>        view.push(viewers[v].getName() + " " + viewers[v].getEmail());
</span><span class='line'>      }
</span><span class='line'>      
</span><span class='line'>      for (var ed=0; ed&lt;editors.length; ed++) {                
</span><span class='line'>        edit.push(editors[ed].getName() + " " + editors[ed].getEmail());
</span><span class='line'>      }
</span><span class='line'>      
</span><span class='line'>      switch(access) {
</span><span class='line'>        case DriveApp.Access.PRIVATE:
</span><span class='line'>          privacy = "Private";
</span><span class='line'>          break;
</span><span class='line'>        case DriveApp.Access.ANYONE:
</span><span class='line'>          privacy = "Anyone";
</span><span class='line'>          break;
</span><span class='line'>        case DriveApp.Access.ANYONE_WITH_LINK:
</span><span class='line'>          privacy = "Anyone with a link";
</span><span class='line'>          break;
</span><span class='line'>        case DriveApp.Access.DOMAIN:
</span><span class='line'>          privacy = "Anyone inside domain";
</span><span class='line'>          break;
</span><span class='line'>        case DriveApp.Access.DOMAIN_WITH_LINK:
</span><span class='line'>          privacy = "Anyone inside domain who has the link";
</span><span class='line'>          break;
</span><span class='line'>        default:
</span><span class='line'>          privacy = "Unknown";
</span><span class='line'>      }
</span><span class='line'>      
</span><span class='line'>      switch(permission) {
</span><span class='line'>        case DriveApp.Permission.COMMENT:
</span><span class='line'>          permission = "can comment";
</span><span class='line'>          break;
</span><span class='line'>        case DriveApp.Permission.VIEW:
</span><span class='line'>          permission = "can view";
</span><span class='line'>          break;
</span><span class='line'>        case DriveApp.Permission.EDIT:
</span><span class='line'>          permission = "can edit";
</span><span class='line'>          break;
</span><span class='line'>        default:
</span><span class='line'>          permission = "";
</span><span class='line'>      }
</span><span class='line'>      
</span><span class='line'>      view = view.join(", ");
</span><span class='line'>            
</span><span class='line'>      edit = edit.join(", ");
</span><span class='line'>            
</span><span class='line'>      privacy += (permission === "" ? "" : " " + permission) 
</span><span class='line'>               + (edit === "" ? "" : "&lt;br&gt;&lt;small&gt;" + edit + " can edit&lt;/small&gt;")
</span><span class='line'>               + (view === "" ? "" : "&lt;br&gt;&lt;small&gt;" + view + " can view&lt;/small&gt;")
</span><span class='line'>      
</span><span class='line'>      rows.push([url, privacy, date]);
</span><span class='line'>      
</span><span class='line'>    } catch (e) {Logger.log(e.toString()); Logger.log(file.getName());};
</span><span class='line'>    
</span><span class='line'>  }
</span><span class='line'>  
</span><span class='line'>  var html = "&lt;p style='text-align:center'&gt;&lt;strong&gt;&lt;a style='font-size:160%;text-decoration:none;color:#49B3F5;' File Permissions Report for Google Drive&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;";
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  html += "&lt;table border='1' cellpadding='5' cellspacing='0'&gt;&lt;tr&gt;&lt;td&gt;&lt;b&gt;" + rows[0].join("&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;b&gt;") + "&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;";
</span><span class='line'>  
</span><span class='line'>  for (var i=1; i&lt;rows.length; i++) {
</span><span class='line'>    html += "&lt;tr&gt;&lt;td&gt;" + rows[i].join("&lt;/td&gt;&lt;td&gt;") + "&lt;/td&gt;&lt;/tr&gt;";
</span><span class='line'>  }
</span><span class='line'>  
</span><span class='line'>  html += "&lt;/table&gt;";
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>  GmailApp.sendEmail(email, "Google Drive - File Permissions Report", "", {htmlBody: html});
</span><span class='line'>  
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/12/upgrade-to-the-new-universal-analytics-syntax-in-sql/">Upgrade to the New Universal Analytics Syntax in SQL</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-07-12T15:14:18-04:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2015/07/12/upgrade-to-the-new-universal-analytics-syntax-in-sql/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Upgrade to the Universal Analytics Syntax in SQL</p>

<p>We are all struggling with upgrading our analytics tools from the old ga.js to the new universal.js plateform.
Most of it is done automatically and would require just changing that ga.js file. But would would happen to event tracking? all that <code>_gaq.push(['_trackEvent', 'button', 'event'])</code> that should be turned into something like this <code>ga('send', 'event', 'button');</code></p>

<p>In this post we are going to update our syntax that is present in a code stored in Postgres. This is very common, just imagine you have a table <code>post</code> with a field <code>body</code> and you want to track some click on a specific post. so you would have something like <code>a href="#" onClick="_gaq.push(['_trackEvent', 'Videos', 'Play', 'Baby\'s First Birthday']);"&gt;Play&lt;/a&gt;</code> . We need to figure out ways to track all the instances of this syntax and then replace it with the new syntax. We don&rsquo;t want to do it by hand if there are more than 2 :), that would take forever!! so let&rsquo;s figure out an automated way</p>

<p>Doing this with a Programming Language would take a long time, the best way seems to be SQL. We need to find all the <code>posts</code> where the tracking event is used:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'> <span class="k">select</span> <span class="n">id</span><span class="p">,</span><span class="n">regexp_matches</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="s1">&#39;_gaq.push\(\[\s*?&#39;&#39;\s*?_trackEvent\s*?&#39;&#39;\s*?,(.+?)\]\)&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="k">match</span>
</span><span class='line'>  <span class="k">from</span>  <span class="n">posts</span> <span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Good, now let&rsquo;s make sure that this would capture multiple instances in a single post, so let&rsquo;s create a query that would display every post and how many matches it has:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">posts</span><span class="p">,</span> <span class="n">regexp_matches</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="s1">&#39;_gaq.push\(\[\s*?&#39;&#39;\s*?_trackEvent\s*?&#39;&#39;\s*?,(.+?)\]\)&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">id</span> <span class="k">HAVING</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>it would look like this:</p>

<pre><code>        id   | count
   19911 |     1
   20894 |     6
   19717 |     8
   19178 |     1
   ..... | .....
</code></pre>

<p>Now that our regex capture all the instances of the old syntax, it is time to change it. Let&rsquo;s update our table with the new syntax:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">begin</span><span class="p">;</span>
</span><span class='line'>  <span class="k">UPDATE</span> <span class="n">posts</span> <span class="k">SET</span> <span class="k">DATA</span> <span class="o">=</span> <span class="n">regexp_replace</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="s1">&#39;_gaq.push\(\[\s*?&#39;&#39;\s*?_trackEvent\s*?&#39;&#39;\s*?,(.+?)\]\)&#39;</span><span class="p">,</span> <span class="s1">&#39;ga(&#39;&#39;send&#39;&#39;,&#39;&#39;event&#39;&#39;,\1)&#39;</span><span class="p">,</span><span class="s1">&#39;gi&#39;</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">WHERE</span> <span class="n">id</span> <span class="k">IN</span> <span class="p">(</span> <span class="k">SELECT</span> <span class="n">id</span> <span class="k">FROM</span> <span class="n">posts</span>
</span><span class='line'>                           <span class="k">WHERE</span> <span class="k">DATA</span><span class="p">::</span><span class="nb">text</span> <span class="k">LIKE</span> <span class="s1">&#39;%_gaq.push%&#39;</span> <span class="p">);</span>
</span><span class='line'><span class="k">commit</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This looks scary but it is not!! I am capturing the parameter for <code>_gaq.push</code> and will create a new function call <code>ga(...)</code>  using the <code>\1</code> .</p>

<p>And you should be ready to go now. You can see the event tracking in real time, that is the best way to test it!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/15/coalesce/">Coalesce</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-15T23:47:14-04:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2015/03/15/coalesce/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you have never heard about the <code>coalesce</code> function, this will be very helpful.
Basically this function exist in most modern DBMS and the definition reads, <code>The COALESCE function in SQL returns the first non-NULL expression among its arguments.</code></p>

<p>let&rsquo;s see a simple example in postgres:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>create table employees
</span><span class='line'>(
</span><span class='line'>        name text,
</span><span class='line'>        hourly_wage int,
</span><span class='line'>        salary int
</span><span class='line'>);
</span><span class='line'>
</span><span class='line'>insert into employees values 
</span><span class='line'>('bob',null,40000),
</span><span class='line'>('sam',40,null);</span></code></pre></td></tr></table></div></figure>


<p>There are 2 ways to determine the annual salary, the first one is by displaying the the value of the salary field and the second one is by calculating that salary from the hourly wage. The problem is that sometimes on of the value is null so we would need a conditional, this is where the <code>coalesce</code> function enter into play.</p>

<p>Let&rsquo;s write a query that will display the annual salary regardless of the <code>null</code> values.</p>

<p><code>select coalesce(hourly_wage*40*52 ,salary) as  "total salary" from employees;</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> total salary 
</span><span class='line'>--------------
</span><span class='line'>40000
</span><span class='line'>83200
</span><span class='line'>(2 rows)</span></code></pre></td></tr></table></div></figure>


<p>Perfect,  we are having the result we want without using a <code>case</code> statement.
Now, I am wondering what would happen if both of the values where null, let&rsquo;s try it out:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>insert into employees values ('jim',null,null);
</span><span class='line'>select coalesce(hourly_wage*40*52 ,salary) as  "total salary" from employees;
</span><span class='line'>
</span><span class='line'>total salary
</span><span class='line'>--------------
</span><span class='line'>        40000
</span><span class='line'>        83200
</span><span class='line'>             
</span><span class='line'>(3 rows)</span></code></pre></td></tr></table></div></figure>


<p>Ok, So if both of the parameters are null then it will return null. However there is a way around it and it is adding another parameter at the end of the parameter list that will be the default , something like this <code>coalesce(ex1,ex2,default_value)</code>. Here is an example with the previous case:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>select coalesce(hourly_wage*40*52 ,salary,0) as  "total salary" from employee;
</span><span class='line'> total salary 
</span><span class='line'>--------------
</span><span class='line'>        40000
</span><span class='line'>        83200
</span><span class='line'>            0
</span><span class='line'>(3 rows)
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/28/fun-with-next-train/">Fun With Next Train</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-28T20:47:14-05:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2015/02/28/fun-with-next-train/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Introduction</h2>

<p><img src="http://i.imgur.com/Ui1zIEI.png" alt="enter image description here" /></p>

<p>I have been playing with creating my own <a href="http://routetomastery.com/blog/2015/02/04/create-your-first-api-wrapper-with-tdd/">API wrapper</a> lately and i didn&rsquo;t find a good use to it.  Fortunately i found inspiration when i saw my colleague building a widget for dashing.</p>

<p>You can see in the image above that using the this the <a href="https://rubygems.org/gems/ruby_wmata">ruby_wmata gem</a> i can see when are the next train coming. but i can also tell when if there are some trains boarding.
It get&rsquo;s more interesting if i go to the <a href="https://developer.wmata.com/docs/services/547636a6f9182302184cda78/operations/547636a6f918230da855363f">WMATA api documentation</a> and see what kind of information i can retrieve about each train:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'><span class="nt">&quot;Trains&quot;</span><span class="p">:[</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;Car&quot;</span><span class="p">:</span><span class="s2">&quot;6&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;Destination&quot;</span><span class="p">:</span><span class="s2">&quot;SilvrSpg&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;DestinationCode&quot;</span><span class="p">:</span><span class="s2">&quot;B08&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;DestinationName&quot;</span><span class="p">:</span><span class="s2">&quot;Silver Spring&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;Group&quot;</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;Line&quot;</span><span class="p">:</span><span class="s2">&quot;RD&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;LocationCode&quot;</span><span class="p">:</span><span class="s2">&quot;A01&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;LocationName&quot;</span><span class="p">:</span><span class="s2">&quot;Metro Center&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;Min&quot;</span><span class="p">:</span><span class="s2">&quot;3&quot;</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'><span class="err">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>mmm, i can get how many cars the train has and more importantly it&rsquo;s direction.
What if i try to track the trains movement on a specific line, would i be able to determine where the trains are in real time? This is the problem i would try to resolve in this post.</p>

<h2>Step 1 : Get the stations code</h2>

<p>Given the information provided earlier, we need to find out where all the trains are in a specific line. In order to achieve that we need to make the <code>GetPrediction</code> on each station, The only problem is that we need a list of station codes to do that. Fortunately, we can use the <code>jPath</code> that will return all the stations between  a <code>FromStationCode</code> and a <code>ToStationCode</code>. So let&rsquo;s try to find all these stations code first.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;ruby_wmata&#39;</span>
</span><span class='line'><span class="no">WMATA</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="s1">&#39;kfgpmgvfgacx98de9q3xazww&#39;</span>
</span><span class='line'><span class="c1">#pick just 9 stations for the demonstration</span>
</span><span class='line'><span class="n">path</span> <span class="o">=</span> <span class="no">WMATA</span><span class="o">.</span><span class="n">train_path</span><span class="p">(</span><span class="s2">&quot;A01&quot;</span><span class="p">,</span><span class="s2">&quot;A15&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">path_by_code</span> <span class="o">=</span> <span class="vi">@path</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">station</span><span class="o">|</span> <span class="n">station</span><span class="o">[</span><span class="s2">&quot;StationCode&quot;</span><span class="o">]</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Step 2 : Find where the trains are</h2>

<p>Now that we have a list of train station codes, we can iterate through it then and make the next train API call. We will retrieve the list of all the arriving trains and sometime we will see that some trains are &ldquo;BRD&rdquo;, it would mean that the location of that train is the stations itself. So whenever we see that let&rsquo;s mark the stations with a &rsquo;T' to indicate the presence of a train and &lsquo;&mdash;&rsquo;  the absence of a trains .
 So i want something that looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">## the first like would represent the 3 first letters of a station&#39;s name</span>
</span><span class='line'><span class="mi">2015</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">28</span> <span class="mi">18</span><span class="p">:</span><span class="mo">04</span><span class="p">:</span><span class="mi">13</span> <span class="o">-</span><span class="mo">0500</span><span class="ss">:Met</span><span class="o">-</span><span class="no">Far</span><span class="o">-</span><span class="no">Dup</span><span class="o">-</span><span class="no">Woo</span><span class="o">-</span><span class="no">Cle</span><span class="o">-</span><span class="no">Van</span><span class="o">-</span><span class="no">Ten</span><span class="o">-</span><span class="no">Fri</span><span class="o">-</span><span class="no">Bet</span>
</span><span class='line'><span class="mi">2015</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">28</span> <span class="mi">18</span><span class="p">:</span><span class="mo">04</span><span class="p">:</span><span class="mi">14</span> <span class="o">-</span><span class="mo">0500</span><span class="ss">:-</span><span class="n">T</span><span class="o">---------------------------------</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Let&rsquo;s code it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">find_trains_in_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="n">path_with_trains</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">path</span><span class="o">.</span><span class="n">each_with_index</span><span class="p">{</span><span class="o">|</span><span class="n">station</span><span class="p">,</span><span class="n">index</span><span class="o">|</span>
</span><span class='line'>    <span class="k">begin</span>
</span><span class='line'>      <span class="n">next_trains</span> <span class="o">=</span> <span class="no">WMATA</span><span class="o">.</span><span class="n">next_trains</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>
</span><span class='line'>      <span class="n">train_boarding?</span><span class="p">(</span><span class="n">next_trains</span><span class="p">)</span> <span class="p">?</span> <span class="n">path_with_trains</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;-T-&quot;</span> <span class="p">:</span> <span class="n">path_with_trains</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;---&quot;</span>
</span><span class='line'>    <span class="k">rescue</span>
</span><span class='line'>      <span class="n">path_with_trains</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;---&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>   <span class="k">return</span> <span class="n">path_with_trains</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we are extracting information about each stations, let&rsquo;s implement the function <code>train_boarding</code> that will tell us if there is a train boarding on that station</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">train_boarding?</span><span class="p">(</span><span class="n">next_trains</span><span class="p">)</span>
</span><span class='line'>  <span class="n">next_trains</span><span class="o">.</span><span class="n">select</span><span class="p">{</span><span class="o">|</span><span class="n">train</span><span class="o">|</span> <span class="n">train</span><span class="o">[</span><span class="s1">&#39;Min&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;BRD&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Step 3 : Update periodically the display to show trains position</h2>

<p>Now that we have all the information we need on a specific time. let&rsquo;s try to update the display every 10s. Also we don&rsquo;t want to show the same information multiple time, so we won&rsquo;t refresh the display if the train are in the same positions.<br/>
We can also add some colors to the display to make it more user friendly using the <code>colorize</code> gem. (we all know that User friendly in a terminal is not possible!! )</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="si">}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">blue</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@path</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">station</span><span class="o">|</span> <span class="n">station</span><span class="o">[</span><span class="s2">&quot;StationName&quot;</span><span class="o">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="o">]</span><span class="si">}</span><span class="s2">.join(&#39;-&#39;)}&quot;</span><span class="o">.</span><span class="n">red</span>
</span><span class='line'><span class="n">last_display</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="k">while</span> <span class="p">(</span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">display</span> <span class="o">=</span> <span class="n">find_trains_in_path</span><span class="p">(</span><span class="vi">@path_by_code</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">display</span> <span class="o">==</span> <span class="n">last_display</span>
</span><span class='line'>    <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="si">}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">blue</span>
</span><span class='line'>    <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">display</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">last_display</span> <span class="o">=</span> <span class="nb">display</span>
</span><span class='line'>  <span class="nb">sleep</span> <span class="mi">10</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here is the final result:</p>

<p><img src="http://i.imgur.com/4WGpuMF.png" alt="enter image description here" /></p>

<p>Obviously,  this implementation is not perfect. We can argue a couple of things
 - We don&rsquo;t really see the direction of the trains
 - What if there are 2 trains going to the opposite directions boarding, we are not showing that information
 - We could replace the last display by the current one but you would not see the movement of the trains
 - We don&rsquo;t show the train when it is between two stations.</p>

<h2>Conclusion</h2>

<p>We came a long way form knowing the next train in a train station to display a whole line with the trains moving in realtime. This method could be implement for any other public transportation with a decent API . The most obvious one would be the next bus.
We can also extend this project to make have a full map with more than one line and see all the train moving in realtime using Javascript and HTML/CSS.Who knows maybe my next project!</p>

<p>You can find the source code for this project <a href="https://github.com/bennacer860/fun_with_trains">here</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/26/activerecord-dirty-change/">ActiveRecord Dirty Change</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-26T22:47:14-05:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2015/02/26/activerecord-dirty-change/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today, After chatting with my colleague and try to fix some <a href="http://api.rubyonrails.org/classes/ActiveRecord/Store.html">ActiveRecord Store bug</a>, he showed me some very neat <a href="http://api.rubyonrails.org/classes/ActiveModel/Dirty.html">ActiveRecord:Dirty</a> method called changed.</p>

<p>I went to Rails documentation and found out the module that allows all this magic. It will tell you if anything has changed on the object.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2.0.0-p598 :109 &gt; c = Content.first
</span><span class='line'>  Content Load (0.8ms)  SELECT  "content".* FROM "content"   ORDER BY "content"."id" ASC LIMIT 1
</span><span class='line'> =&gt; #&lt;Content id: 1, content_type_id: 2, name: "culture page", url_name: "culture_page", options: {}, creator_id: 123, created_at: "2014-04-21 17:02:23", updated_at: "2014-05-30 18:44:41", published_at: "2014-04-21 17:02:23", removed_at: "2014-05-30 18:44:41"&gt;
</span><span class='line'>2.0.0-p598 :110 &gt; c.changed?
</span><span class='line'> =&gt; false
</span><span class='line'>2.0.0-p598 :111 &gt; c.name = "hi"
</span><span class='line'> =&gt; "hi"
</span><span class='line'>2.0.0-p598 :112 &gt; c.changed?
</span><span class='line'> =&gt; true
</span><span class='line'>2.0.0-p598 :113 &gt; c.changed
</span><span class='line'> =&gt; ["name"]
</span><span class='line'>2.0.0-p598 :115 &gt; c.name_change
</span><span class='line'> =&gt; ["culture page", "hi"]
</span><span class='line'> 2.0.0-p598 :118 &gt; c.changes
</span><span class='line'> =&gt; {"name"=&gt;["culture page", "hi"]}
</span><span class='line'> 2.0.0-p598 :114 &gt; c.name_was
</span><span class='line'> =&gt; "culture page"</span></code></pre></td></tr></table></div></figure>


<p>If you really to avoid saving and making useless DB call. you can always use this module.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/17/rspec-internals-part-1/">Rspec Internals (Part 1)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-17T13:53:30-05:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2015/02/17/rspec-internals-part-1/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you wonder how Rspec is built and is curious about the internals of such a tool then this article is for you. After watching an episode from the excellent <a href="https://www.destroyallsoftware.com/talks">Gary Bernhard&rsquo;s Destroy all software series</a> ,i decided to blog about it to make sure i understand how it works.</p>

<p>We will use Minitest TestCase to test the most basic Rspec syntax. As usual let&rsquo;s write two tests, one that pass and another one that fails. And we will write the code that defines the Rspec features in spec.rb. but lets start with just the tests:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;spec&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">TesDecribe</span> <span class="o">&lt;</span> <span class="no">MiniTest</span><span class="o">::</span><span class="no">Unit</span><span class="o">::</span><span class="no">TestCase</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_that_it_can_pass</span>
</span><span class='line'>    <span class="n">describe</span> <span class="s1">&#39;some description&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">it</span> <span class="s1">&#39;has some property&#39;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_that_it_can_fail</span>
</span><span class='line'>    <span class="n">assert_raises</span><span class="p">(</span><span class="no">IndexError</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">describe</span> <span class="s1">&#39;some failing test&#39;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">it</span> <span class="s1">&#39;fails&#39;</span> <span class="k">do</span>
</span><span class='line'>          <span class="k">raise</span> <span class="no">IndexError</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running this will throw a bunch of errors :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Finished</span> <span class="k">in</span> <span class="mi">0</span><span class="o">.</span><span class="mo">001565</span><span class="n">s</span><span class="p">,</span> <span class="mi">1277</span><span class="o">.</span><span class="mi">9553</span> <span class="n">runs</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="mi">638</span><span class="o">.</span><span class="mi">9776</span> <span class="n">assertions</span><span class="o">/</span><span class="n">s</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">1</span><span class="p">)</span> <span class="ss">Failure</span><span class="p">:</span>
</span><span class='line'><span class="no">TestDescribe</span><span class="c1">#test_that_it_can_fail [test.rb:13]:</span>
</span><span class='line'><span class="no">IndexError</span> <span class="n">expected</span> <span class="n">but</span> <span class="n">nothing</span> <span class="n">was</span> <span class="n">raised</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="mi">2</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">1</span> <span class="n">assertions</span><span class="p">,</span> <span class="mi">1</span> <span class="n">failures</span><span class="p">,</span> <span class="mi">0</span> <span class="n">errors</span><span class="p">,</span> <span class="mi">0</span> <span class="n">skips</span>
</span></code></pre></td></tr></table></div></figure>


<p>Interesting, It seems like the  describe method is defined somehow but the block inside is not executed. It is time to start working on that spec.rb file</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#lets define describe method that will pick a description and a block and let&#39;s call that block</span>
</span><span class='line'><span class="k">def</span> <span class="nf">describe</span> <span class="n">description</span><span class="p">,</span><span class="o">&amp;</span><span class="n">block</span>
</span><span class='line'>  <span class="n">block</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>let&rsquo;s run our test again</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Finished</span> <span class="k">in</span> <span class="mi">0</span><span class="o">.</span><span class="mo">001240</span><span class="n">s</span><span class="p">,</span> <span class="mi">1612</span><span class="o">.</span><span class="mi">9032</span> <span class="n">runs</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="mi">806</span><span class="o">.</span><span class="mi">4516</span> <span class="n">assertions</span><span class="o">/</span><span class="n">s</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">1</span><span class="p">)</span> <span class="ss">Error</span><span class="p">:</span>
</span><span class='line'><span class="no">TestDescribe</span><span class="c1">#test_describe_method:</span>
</span><span class='line'><span class="ss">NoMethodError</span><span class="p">:</span> <span class="n">undefined</span> <span class="nb">method</span> <span class="sb">`it&#39; for #&lt;TestDescribe:0x007fb8158a2558&gt;</span>
</span><span class='line'><span class="sb">    test.rb:10:in `</span><span class="n">block</span> <span class="k">in</span> <span class="n">test_describe_method</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">    test.rb:4:in `call&#39;</span>
</span><span class='line'>    <span class="nb">test</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">4</span><span class="ss">:in</span> <span class="sb">`describe&#39;</span>
</span><span class='line'><span class="sb">    test.rb:9:in `</span><span class="n">test_describe_method</span><span class="s1">&#39;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="s1">  2) Failure:</span>
</span><span class='line'><span class="s1">TestDescribe#test_that_it_can_fail [test.rb:17]:</span>
</span><span class='line'><span class="s1">[IndexError] exception expected, not</span>
</span><span class='line'><span class="s1">Class: &lt;NoMethodError&gt;</span>
</span><span class='line'><span class="s1">Message: &lt;&quot;undefined method `it&#39;</span> <span class="k">for</span> <span class="c1">#&lt;TestDescribe:0x007fb8158a1e50&gt;&quot;&gt;</span>
</span><span class='line'><span class="o">---</span><span class="no">Backtrace</span><span class="o">---</span>
</span><span class='line'><span class="nb">test</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">19</span><span class="ss">:in</span> <span class="sb">`block (2 levels) in test_that_it_can_fail&#39;</span>
</span><span class='line'><span class="sb">test.rb:4:in `</span><span class="n">call</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">test.rb:4:in `describe&#39;</span>
</span><span class='line'><span class="nb">test</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">18</span><span class="ss">:in</span> <span class="sb">`block in test_that_it_can_fail&#39;</span>
</span><span class='line'><span class="sb">---------------</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is the same Exception, the block inside <code>describe</code> gets executed but there is an undefined method <code>it</code> inside. The <code>it</code> method is pretty much the same as <code>describe</code>, it will take a description and a block and will execute that block. Let&rsquo;s update our spec.rb:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#lets define describe method that will pick a description and a block and let&#39;s call that block</span>
</span><span class='line'><span class="k">def</span> <span class="nf">describe</span> <span class="n">description</span><span class="p">,</span><span class="o">&amp;</span><span class="n">block</span>
</span><span class='line'> <span class="n">block</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">it</span> <span class="n">description</span><span class="p">,</span><span class="o">&amp;</span><span class="n">block</span>
</span><span class='line'> <span class="n">block</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p> let&rsquo;s run our tests again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Finished</span> <span class="k">in</span> <span class="mi">0</span><span class="o">.</span><span class="mo">000</span><span class="mi">968</span><span class="n">s</span><span class="p">,</span> <span class="mi">2066</span><span class="o">.</span><span class="mi">1157</span> <span class="n">runs</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="mi">1033</span><span class="o">.</span><span class="mo">057</span><span class="mi">9</span> <span class="n">assertions</span><span class="o">/</span><span class="n">s</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="mi">2</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">1</span> <span class="n">assertions</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span><span class="p">,</span> <span class="mi">0</span> <span class="n">errors</span><span class="p">,</span> <span class="mi">0</span> <span class="n">skips</span>
</span></code></pre></td></tr></table></div></figure>


<p>Good this is working, i can use that <code>describe do .... end</code> syntax, but how about assertions, i want to be able to do something like <code>2.should == 2</code>. As Usual let&rsquo;s do the same and build 2 tests, a passing one and a failing one.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">TestAssertion</span>  <span class="o">&lt;</span> <span class="no">MiniTest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_that_it_can_pass</span>
</span><span class='line'>    <span class="mi">2</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="mi">2</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_that_it_can_fail</span>
</span><span class='line'>    <span class="n">assert_raises</span> <span class="no">AssertionError</span> <span class="k">do</span>
</span><span class='line'>      <span class="mi">1</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span>  <span class="mi">2</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Obviously running test will not pass:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Finished</span> <span class="k">in</span> <span class="mi">0</span><span class="o">.</span><span class="mo">001312</span><span class="n">s</span><span class="p">,</span> <span class="mi">3048</span><span class="o">.</span><span class="mi">7805</span> <span class="n">runs</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="mi">762</span><span class="o">.</span><span class="mi">1951</span> <span class="n">assertions</span><span class="o">/</span><span class="n">s</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">1</span><span class="p">)</span> <span class="ss">Error</span><span class="p">:</span>
</span><span class='line'><span class="no">TestAssertion</span><span class="c1">#test_that_it_can_fail:</span>
</span><span class='line'><span class="ss">NameError</span><span class="p">:</span> <span class="n">uninitialized</span> <span class="n">constant</span> <span class="no">TestAssertion</span><span class="o">::</span><span class="no">AssertionError</span>
</span><span class='line'>    <span class="nb">test</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">17</span><span class="ss">:in</span> <span class="sb">`test_that_it_can_fail&#39;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="sb">  2) Error:</span>
</span><span class='line'><span class="sb">TestAssertion#test_that_it_can_pass:</span>
</span><span class='line'><span class="sb">NoMethodError: undefined method `</span><span class="n">should</span><span class="s1">&#39; for 2:Fixnum</span>
</span><span class='line'><span class="s1">    test.rb:13:in `test_that_it_can_pass&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I see two things , an undefined method <code>should</code> and an undefined Exception AssertionError. Let&rsquo;s update spec.rb:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="c1">#this is easy fix, just define an exception</span>
</span><span class='line'><span class="k">class</span> <span class="nc">AssertionErro</span> <span class="o">&lt;</span> <span class="no">Exception</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In order to implement the <code>should</code> we need to create an assertion for the object passed and it needs to work for all ruby objects so we will implement it for the <code>Object</code> class. You also need to remember that &lsquo;==&rsquo; is just syntactic sugar offered by ruby and it is the equivalent of &lsquo;equal?&rsquo;.  Basically, <code>2 == 2</code> is the same as <code>2.equal?(2)</code> . this is very important because we will define a <code>==</code> method in our <code>DelayedAssertion</code> class. Enough talking, let&rsquo;s take a look at the code in spec.rb:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Object</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">should</span>
</span><span class='line'>    <span class="no">DelayedAssertion</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#lets define DelayedAssertion class now</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">DelayedAssertion</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@subject</span> <span class="o">=</span> <span class="n">subject</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1">#here where the magic happens</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">==</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span class='line'>    <span class="k">raise</span> <span class="no">AssertionError</span> <span class="k">unless</span> <span class="vi">@subject</span> <span class="o">==</span> <span class="n">other</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>let&rsquo;s run the test now:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Running:</span>
</span><span class='line'>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'>
</span><span class='line'><span class="no">Finished</span> <span class="k">in</span> <span class="mi">0</span><span class="o">.</span><span class="mo">0013</span><span class="mi">84</span><span class="n">s</span><span class="p">,</span> <span class="mi">2890</span><span class="o">.</span><span class="mi">1734</span> <span class="n">runs</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="mi">1445</span><span class="o">.</span><span class="mi">0867</span> <span class="n">assertions</span><span class="o">/</span><span class="n">s</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="mi">4</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">2</span> <span class="n">assertions</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span><span class="p">,</span> <span class="mi">0</span> <span class="n">errors</span><span class="p">,</span> <span class="mi">0</span> <span class="n">skips</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wow,  we have been able to implement some major features of Rspec. In future post i will try to add support to should method such as  <code>something.should be_true</code> or <code>array.should have(4).things</code>. You can also add your implementation as a comments.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/04/create-your-first-api-wrapper-with-tdd/">Create Your First API Wrapper With TDD</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-04T22:47:14-05:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2015/02/04/create-your-first-api-wrapper-with-tdd/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Whether at you job or personal projects you would need at some point have to build you own API wrapper in ruby. Today, i decided to build my own Wrapper that i will turn into a gem in a later blog post. I want to do it methodically according to Test Driven Development principles.</p>

<p>It is always a hassle to test API calls but there is a way on how it should be done and we will talk about it later on.</p>

<p>I picked the <a href="https://developer.wmata.com/">WMATA API</a> because it is well written and well documented. As you can see in their developer website each call has <a href="https://developer.wmata.com/docs/services/547636a6f9182302184cda78/operations/547636a6f918230da855363f">a json response example</a>. We will use these to test our code against it later.</p>

<p>Let&rsquo;s talk about our goal. I want to be able to set <a href="https://developer.wmata.com/demokey">my api key</a> and then make an api call in this manner:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">WMATA</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="s2">&quot;kfgpmgvfgacx98de9q3xazww&quot;</span>
</span><span class='line'><span class="no">WMATA</span><span class="o">.</span><span class="n">next_trains</span><span class="p">(</span><span class="s2">&quot;A01&quot;</span><span class="p">)</span> <span class="c1"># A01 stands for a station code</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, that i know what i want, let&rsquo;s set up our TDD environment. The initial repository tree would look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">lib</span>
</span><span class='line'><span class="o">|</span><span class="n">___wamta</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="n">spec</span>
</span><span class='line'><span class="o">|</span><span class="n">___spec_helper</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">|</span><span class="n">___trains_helper</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="no">Gemfile</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s take a look at the <code>Gemfile</code> and see what are the tools we are going to use:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;httparty&#39;</span> <span class="c1">#i use httparty to make http queries </span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;pry&#39;</span> <span class="c1">#i use binding.pry to open a IRB console during runtime</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;webmock&#39;</span> <span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:test</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;rspec&#39;</span> <span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:test</span> <span class="c1"># this is my favorite testing framework</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have all the necessary gems do a <code>bundle install</code>. Let&rsquo;s take a look at the <code>spec/spec_helper.rb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vg">$:</span><span class="o">.</span><span class="n">unshift</span> <span class="s1">&#39;lib&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;wmata&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;webmock/rspec&#39;</span>
</span><span class='line'><span class="no">WebMock</span><span class="o">.</span><span class="n">disable_net_connect!</span><span class="p">(</span><span class="ss">allow_localhost</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">stub_request</span><span class="p">(</span><span class="ss">:get</span><span class="p">,</span> <span class="sr">%r|https://api.wmata.com/StationPrediction.svc/json/GetPrediction/|</span><span class="p">)</span><span class="o">.</span>
</span><span class='line'>        <span class="n">to_return</span><span class="p">(</span><span class="ss">status</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="ss">body</span><span class="p">:</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;./spec/fixtures/next_trains.json&quot;</span><span class="p">){</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">},</span> <span class="ss">headers</span><span class="p">:</span> <span class="p">{})</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is where it get&rsquo;s tricky. If you rely on the API, your tests are not really tests, because they depend on the status of the API. If you have no internet, those tests will not work. Your tests should only test your own code, not the response of the API. We are using webmock to return to each call made to <code>https://api.wmata.com/StationPrediction.svc/json/GetPrediction/</code> the json response  in <code>next_trains.json</code>. This response is the expected result provided by the documentation <a href="https://developer.wmata.com/docs/services/547636a6f9182302184cda78/operations/547636a6f918230da855363f">here</a></p>

<p> So let&rsquo;s add the file <code>next_trains.json</code> in <code>spec/fixtures/next_trains.json</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'><span class="nt">&quot;Trains&quot;</span><span class="p">:[</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="nt">&quot;Car&quot;</span><span class="p">:</span><span class="s2">&quot;6&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;Destination&quot;</span><span class="p">:</span><span class="s2">&quot;SilvrSpg&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;DestinationCode&quot;</span><span class="p">:</span><span class="s2">&quot;B08&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;DestinationName&quot;</span><span class="p">:</span><span class="s2">&quot;Silver Spring&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;Group&quot;</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;Line&quot;</span><span class="p">:</span><span class="s2">&quot;RD&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;LocationCode&quot;</span><span class="p">:</span><span class="s2">&quot;A01&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;LocationName&quot;</span><span class="p">:</span><span class="s2">&quot;Metro Center&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;Min&quot;</span><span class="p">:</span><span class="s2">&quot;3&quot;</span>
</span><span class='line'><span class="p">},</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="nt">&quot;Car&quot;</span><span class="p">:</span><span class="s2">&quot;6&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;Destination&quot;</span><span class="p">:</span><span class="s2">&quot;Grsvnor&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;DestinationCode&quot;</span><span class="p">:</span><span class="s2">&quot;A11&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;DestinationName&quot;</span><span class="p">:</span><span class="s2">&quot;Grosvenor-Strathmore&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;Group&quot;</span><span class="p">:</span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;Line&quot;</span><span class="p">:</span><span class="s2">&quot;RD&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;LocationCode&quot;</span><span class="p">:</span><span class="s2">&quot;A01&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;LocationName&quot;</span><span class="p">:</span><span class="s2">&quot;Metro Center&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;Min&quot;</span><span class="p">:</span><span class="s2">&quot;4&quot;</span>
</span><span class='line'><span class="p">}]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have everything setup now let&rsquo;s write our first test in <code>spec/train_spec.rb</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
</span><span class='line'><span class="n">describe</span> <span class="no">WMATA</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="p">{</span> <span class="no">WMATA</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="s1">&#39;xxxxx&#39;</span>  <span class="p">}</span>
</span><span class='line'>     <span class="n">it</span> <span class="s1">&#39;should predict next trains&#39;</span> <span class="k">do</span>
</span><span class='line'>       <span class="n">expect</span><span class="p">(</span><span class="no">WMATA</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">respond_to</span> <span class="ss">:next_trains</span>
</span><span class='line'>       <span class="n">next_trains</span> <span class="o">=</span> <span class="no">WMATA</span><span class="o">.</span><span class="n">next_trains</span>
</span><span class='line'>       <span class="n">expect</span><span class="p">(</span><span class="n">next_trains</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_empty</span>
</span><span class='line'>       <span class="o">[</span><span class="s2">&quot;Car&quot;</span><span class="p">,</span><span class="s2">&quot;Min&quot;</span><span class="p">,</span><span class="s2">&quot;DestinationName&quot;</span><span class="o">].</span><span class="n">each</span><span class="p">{</span> <span class="o">|</span><span class="n">field</span><span class="o">|</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">next_trains</span><span class="o">.</span><span class="n">first</span><span class="o">[</span><span class="n">field</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_nil</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that the api key does not have to be real because the call to the live api will not be made. It will be mocked and will return the expected json response.</p>

<p>Let&rsquo;s create the module that will handle the API calls in <code>lib/wamta.rb</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vg">$:</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">))</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;client&#39;</span>
</span><span class='line'><span class="k">module</span> <span class="nn">WMATA</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">client</span>
</span><span class='line'>    <span class="vi">@client</span> <span class="o">||=</span> <span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">api</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">api</span>
</span><span class='line'>    <span class="vi">@api</span> <span class="o">||</span> <span class="k">raise</span><span class="p">(</span><span class="s2">&quot;please set the api key&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">api</span><span class="o">=</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@client</span> <span class="o">=</span> <span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@api</span> <span class="o">=</span> <span class="n">api_key</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">next_trains</span><span class="p">(</span><span class="n">station</span> <span class="o">=</span> <span class="s2">&quot;A06&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">client</span><span class="o">.</span><span class="n">next_trains</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Good, now we have a module that will create a client object when an api_key is passed and if we want to call <code>next_trains</code> without setting up the api key it will throw an exception &ldquo;please set the api key&rdquo;. Now, let&rsquo;s create the Client class in <code>lib/client.rb</code> that will actually handle the API calls.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;httparty&#39;</span>
</span><span class='line'><span class="k">module</span> <span class="nn">WMATA</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Client</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">HTTParty</span>
</span><span class='line'>    <span class="n">base_uri</span> <span class="s2">&quot;https://api.wmata.com&quot;</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@options</span> <span class="o">=</span> <span class="p">{</span><span class="ss">query</span><span class="p">:</span> <span class="p">{</span><span class="ss">api_key</span><span class="p">:</span> <span class="n">api_key</span><span class="p">}</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">next_trains</span><span class="p">(</span><span class="n">stations</span><span class="o">=</span><span class="s1">&#39;A06&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">response</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/StationPrediction.svc/json/GetPrediction/</span><span class="si">#{</span><span class="n">stations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="vi">@options</span><span class="p">)</span>
</span><span class='line'>      <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">[</span><span class="s2">&quot;Trains&quot;</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>When you run the tests now, everything should be green. This part makes sure that our code handles correctly the expected response, now let&rsquo;s make a live API call :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">WMATA</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="s2">&quot;kfgpmgvfgacx98de9q3xazww&quot;</span>
</span><span class='line'><span class="no">WMATA</span><span class="o">.</span><span class="n">next_trains</span><span class="p">(</span><span class="s2">&quot;A01&quot;</span><span class="p">)</span> <span class="c1"># A01 stands for a station code</span>
</span></code></pre></td></tr></table></div></figure>


<p>It should return an array of all the next trains for the specified station. Now that it is working we can do the same for all the other api calls</p>

<p><img src="http://i.imgur.com/tEiuIfo.png" alt="alt" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/02/httparty-debugging/">HTTParty Debugging</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-01-02T15:24:47-05:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2015/01/02/httparty-debugging/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Whenever you start working on API call you should use HTTParty. In my opinion it is the best tool to make a API wrapper in a very modular way.I have been playing with it lately, and i got this weird error</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/Users/***/.rvm/rubies/ruby-2.1.5/lib/ruby/2.1.0/uri/generic.rb:214:in `initialize':
</span><span class='line'>the scheme http does not accept registry part: :80 (or bad hostname?) (URI::InvalidURIError)`</span></code></pre></td></tr></table></div></figure>


<p>Well, i know that HTTParty rely on URI module, but i would like to have more details in order to debug it. How about getting more verbose for the http requests i am making. The solution is easy, HTTParty provides a simple tool called debug_output. You can display the debug in stderr and it will show you only the errors or jsut be more verbose and use stdout, it woudl be something like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="kp">include</span> <span class="no">HTTParty</span>
</span><span class='line'><span class="n">debug_output</span> <span class="vg">$stdout</span>
</span></code></pre></td></tr></table></div></figure>


<p>let see the output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">opening</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">api</span><span class="o">.</span><span class="n">themoviedb</span><span class="o">.</span><span class="n">org</span><span class="p">:</span><span class="mi">80</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">opened</span>
</span><span class='line'><span class="o">&lt;-</span> <span class="s2">&quot;GET /3movie/12?api_key=87465574ffc9 HTTP/1.1</span><span class="se">\r\n</span><span class="s2">Accept: application/json</span><span class="se">\r\n</span><span class="s2">Content-Type: application/json</span><span class="se">\r\n</span><span class="s2">Connection: close</span><span class="se">\r\n</span><span class="s2">Host: api.themoviedb.org</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="o">-&gt;</span> <span class="s2">&quot;HTTP/1.1 404 Not Found</span><span class="se">\r\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="o">-&gt;</span> <span class="s2">&quot;Content-Type: text/html</span><span class="se">\r\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="o">-&gt;</span> <span class="s2">&quot;Date: Fri, 02 Jan 2015 20:20:30 GMT</span><span class="se">\r\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="o">-&gt;</span> <span class="s2">&quot;Server: nginx</span><span class="se">\r\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="o">-&gt;</span> <span class="s2">&quot;Content-Length: 162</span><span class="se">\r\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="o">-&gt;</span> <span class="s2">&quot;Connection: Close</span><span class="se">\r\n</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Mmmm&hellip;i was making a /3movie/ call instead of movie/3, i know what my problem is now.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/07/12/find-who-is-accessing-my-google-drive-files/">Find Who is Accessing my Google Drive Files</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/12/upgrade-to-the-new-universal-analytics-syntax-in-sql/">Upgrade to the new Universal Analytics Syntax in SQL</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/15/coalesce/">Coalesce</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/28/fun-with-next-train/">Fun with next train</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/26/activerecord-dirty-change/">ActiveRecord dirty change</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Rafik Bennacer -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'roadtomastery';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
